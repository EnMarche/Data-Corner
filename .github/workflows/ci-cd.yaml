name: Continuous Integration & Deployment

on:
  push:
    branches: [ master ]
  pull_request:
  release:
    types: [ published ]

jobs:
  test:
    name: Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: ./.github/actions/setup-node-yarn
      - run: |-
          yarn lint
      - run: |-
          yarn test

  deploy-staging:
    name: Deploy to Staging üçæ
    runs-on: ubuntu-latest
    needs: [ test ]
    if: github.event.ref == 'refs/heads/master'
    environment: staging

    steps:
      - uses: actions/checkout@v2
      - uses: ./.github/actions/setup-node-yarn
      - uses: ./.github/actions/gcs-deploy
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY_GCS_PUSHER_DATACORNER }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          bucket: ${{ secrets.GCP_GCS_BUCKET }}
          react_app_oauth_host: ${{ secrets.REACT_APP_OAUTH_HOST }}
          react_app_oauth_client_id: ${{ secrets.REACT_APP_OAUTH_CLIENT_ID }}
          react_app_internal_app_id: ${{ secrets.REACT_APP_INTERNAL_APP_ID }}
          react_app_sentry_dsn: ${{ secrets.REACT_APP_SENTRY_DSN }}
          react_app_unlayer_project_id: ${{ secrets.REACT_APP_UNLAYER_PROJECT_ID }}
          react_app_mapbox_token: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          react_app_mapbox_style: ${{ secrets.REACT_APP_MAPBOX_STYLE }}

  deploy-prod:
    name: Deploy to Prod üçæ
    runs-on: ubuntu-latest
    needs: [ test ]
    if: github.event_name == 'release'
    environment: production

    steps:
      - uses: actions/checkout@v2
      - uses: ./.github/actions/setup-node-yarn
      - uses: ./.github/actions/gcs-deploy
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY_GCS_PUSHER_DATACORNER }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          bucket: ${{ secrets.GCP_GCS_BUCKET }}
          react_app_oauth_host: ${{ secrets.REACT_APP_OAUTH_HOST }}
          react_app_oauth_client_id: ${{ secrets.REACT_APP_OAUTH_CLIENT_ID }}
          react_app_internal_app_id: ${{ secrets.REACT_APP_INTERNAL_APP_ID }}
          react_app_sentry_dsn: ${{ secrets.REACT_APP_SENTRY_DSN }}
          react_app_unlayer_project_id: ${{ secrets.REACT_APP_UNLAYER_PROJECT_ID }}
          react_app_mapbox_token: ${{ secrets.REACT_APP_MAPBOX_TOKEN }}
          react_app_mapbox_style: ${{ secrets.REACT_APP_MAPBOX_STYLE }}
